<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TimTec Catalog Assistant v2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: sans-serif;
    }
    #chat-box::-webkit-scrollbar {
      width: 6px;
    }
    #chat-box::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 6px;
    }
    .chat-bubble {
      max-width: 80%;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-2xl h-[80vh] bg-white rounded-2xl shadow-lg flex flex-col">
    <header class="bg-blue-600 text-white px-6 py-4 rounded-t-2xl">
      <h1 class="text-xl font-semibold">TimTec Product Chatbot</h1>
      <p class="text-sm">Search using TimTec ID, IUPAC, or SMILES</p>
    </header>
    <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4">
        <!-- Initial bot message -->
        <div class="text-left">
            <div class="inline-block bg-gray-100 text-black px-4 py-2 rounded-xl chat-bubble">
                Welcome! How can I help you find a product today?
            </div>
        </div>
    </div>
    <footer class="p-4 border-t flex">
      <input id="query" class="flex-1 border rounded-full px-4 py-2" placeholder="Enter query...">
      <button id="search" class="ml-3 px-4 py-2 bg-blue-600 text-white rounded-full">Search</button>
    </footer>
  </div>

  <script>
    // --- STEP 1: PASTE YOUR JSON DATA HERE ---
    // Replace the example data below with the JSON data you converted from your CSV file.
    const catalog = [
        // Example product format:
        // {
        //   "TimTec_ID": "ST000001",
        //   "IUPAC": "Example Compound 1",
        //   "SMILES": "C1=CC=CC=C1",
        //   "Amount": "100mg",
        //   "InStock_Tampa": "Yes",
        //   "Purity": "98%",
        //   "MolecularWeight": "122.12",
        //   "Price_1mg": "100",
        //   "Price_2mg": "120",
        //   "Price_5mg": "180"
        // }
    ];
    // --- END OF DATA SECTION ---


    const priceMatrix = [
      { range: [201, 1000], prices: [30, 40, 50, 80, 150, 220, 250, 280] },
      { range: [101, 200], prices: [30, 60, 80, 100, 200, 300, 350, 400] },
      { range: [51, 100],  prices: [70, 90, 140, 180, 280, 350, 390, 440] },
      { range: [21, 50],   prices: [80, 100, 150, 200, 290, 360, 400, 480] },
      { range: [6, 20],    prices: [90, 110, 160, 260, 320, 450, 500, null] },
      { range: [1, 5],     prices: [100, 120, 180, 290, null, null, null, null] }
    ];

    const doseMap = ['1mg', '2mg', '5mg', '10mg', '15mg', '20mg', '30mg', '50mg'];

    const fallbackPrice = (dose, amount) => {
      const amt = parseFloat(amount);
      if (isNaN(amt)) return 'Request';
      const row = priceMatrix.find(r => amt >= r.range[0] && amt <= r.range[1]);
      if (!row) return 'Request';
      const idx = doseMap.indexOf(dose);
      return row.prices[idx] !== null ? `$${row.prices[idx]}` : 'Request';
    };

    function displayMessage(sender, text) {
      const chatBox = document.getElementById('chat-box');
      const div = document.createElement('div');
      div.className = sender === 'bot' ? 'text-left' : 'text-right';
      div.innerHTML = `<div class="inline-block bg-${sender === 'bot' ? 'gray' : 'blue'}-100 text-black px-4 py-2 rounded-xl chat-bubble">${text}</div>`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll
    }

    function formatResult(product) {
      let pricing = '';
      doseMap.forEach(dose => {
        const raw = product[`Price_${dose}`];
        // Check for empty, null, or "request" style strings
        const priceIsRequest = !raw || String(raw).trim() === '' || isNaN(parseFloat(raw));
        const price = priceIsRequest ? fallbackPrice(dose, product.Amount) : `$${raw}`;
        if (price) pricing += `<li class="text-sm">${dose}: <strong>${price}</strong></li>`;
      });

      return `
        <div class="border-b pb-2 mb-2">
          <strong>${product.TimTec_ID}</strong><br>
          <em>${product.IUPAC || 'N/A'}</em><br>
          <ul class='list-disc ml-6 mt-2'>${pricing}</ul>
          <p class="text-sm mt-2">In Stock (Tampa): <strong>${product.InStock_Tampa || 'Check Availability'}</strong></p>
          <p class="text-sm">Purity: <strong>${product.Purity || 'N/A'}</strong>, MW: ${product.MolecularWeight || 'N/A'}</p>
        </div>
      `;
    }

    function performSearch() {
        const input = document.getElementById('query');
        const q = input.value.trim().toLowerCase();
        if (!q) return;

        displayMessage('user', input.value);
        input.value = '';

        // Feedback to user
        setTimeout(() => {
            const results = catalog.filter(p =>
                (p.TimTec_ID && p.TimTec_ID.toLowerCase() === q) ||
                (p.SMILES && p.SMILES.toLowerCase() === q) ||
                (p.IUPAC && p.IUPAC.toLowerCase().includes(q))
            );

            if (results.length > 0) {
                let response = results.length > 1 ? `Found ${results.length} matching products:<br><br>` : '';
                results.forEach(result => {
                    response += formatResult(result);
                });
                displayMessage('bot', response);
            } else {
                displayMessage('bot', `No products found matching "${q}". Please check the ID or try a different search term.`);
            }
        }, 500); // Simulate a quick search
    }

    document.getElementById('search').onclick = performSearch;
    document.getElementById('query').addEventListener('keyup', (event) => {
        if (event.key === 'Enter') {
            performSearch();
        }
    });
  </script>
</body>
</html>